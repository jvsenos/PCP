<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>M2Visual | PCP - Escala Di√°ria</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
  --cor-primaria: #001f3f;
  --cor-secundaria: #f7f9fb;
  --cor-fundo: #eaf1f8;
  --cor-texto: #333;
  --cor-sucesso: #28a745;
  --cor-aviso: #ffc107;
  --cor-erro: #dc3545;
  --cor-info: #007bff;
  --sombra: 0 8px 16px rgba(0,0,0,0.1);
  --sombra-suave: 0 4px 8px rgba(0,0,0,0.05);
  --borda-arredondada: 12px;
}
body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--cor-fundo); margin:0; padding:0; color: var(--cor-texto); display:flex; flex-direction:column; min-height:100vh; transition: background 0.3s, color 0.3s; }

/* Dark Mode */
body.dark-mode {
  --cor-primaria: #bbd0e3;
  --cor-secundaria: #1f2a38;
  --cor-fundo: #0e1621;
  --cor-texto: #e0e8f0;
  --cor-sucesso: #4cd13a;
  --cor-aviso: #ffcc5c;
  --cor-erro: #ff6b6b;
  --cor-info: #5dade2;
  --sombra: 0 8px 16px rgba(0,0,0,0.5);
  --sombra-suave: 0 4px 8px rgba(0,0,0,0.2);
}
body.dark-mode .header { background: #1f2a38; box-shadow: var(--sombra-suave); }
body.dark-mode .header h2 { color: var(--cor-texto); }
body.dark-mode .container,
body.dark-mode .form-section,
body.dark-mode .info-box,
body.dark-mode .dropdown-content,
body.dark-mode #preview { background: var(--cor-secundaria); border-color: #333; }
body.dark-mode .form-section label { color: var(--cor-primaria); }
body.dark-mode .form-section input,
body.dark-mode .form-section textarea,
body.dark-mode .form-section select { background: #2a3541; border-color: #555; color: var(--cor-texto); }
body.dark-mode .form-section input:focus,
body.dark-mode .form-section textarea:focus,
body.dark-mode .form-section select:focus { border-color: var(--cor-sucesso); }
body.dark-mode .checkbox-group label { background: #2a3541; border-color: #444; color: var(--cor-primaria); }
body.dark-mode .checkbox-group label:hover { background: #344252; }
body.dark-mode .service-box { background: #2a3541; border-left-color: var(--cor-info); }
body.dark-mode .service-box h3,
body.dark-mode .service-box p,
body.dark-mode .service-box strong { color: var(--cor-primaria); }
body.dark-mode .service-box .actions button { background: #445161; color: var(--cor-texto); }
body.dark-mode .dropdown-content button { background: transparent; color: var(--cor-texto); }
body.dark-mode .dropdown-content button:hover { background: #445161; }
body.dark-mode .footer { background: #1f2a38; }
body.dark-mode .tooltip { background-color: var(--cor-primaria); color: var(--cor-secundaria); }
body.dark-mode .tooltip::after { background-color: var(--cor-primaria); }

.header {
  background: var(--cor-primaria); padding: 25px 15px; display:flex; align-items:center; justify-content:center;
  gap:20px; flex-wrap:wrap; box-shadow: var(--sombra-suave); position: relative;
}
.header img { height:60px; border-radius:8px; }
.header h2 { color:#fff; margin:0; font-size:28px; white-space:nowrap; }

.mode-toggle { position: absolute; top: 15px; right: 15px; width: 50px; height: 28px; cursor: pointer; }
.mode-toggle input { display: none; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc; transition: .4s; border-radius: 34px;
}
.slider:before {
    position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px;
    background-color: white; transition: .4s; border-radius: 50%;
}
input:checked + .slider { background-color: #2196F3; }
input:focus + .slider { box-shadow: 0 0 1px #2196F3; }
input:checked + .slider:before { transform: translateX(22px); }

.container {
  max-width:900px; margin:30px auto; background: var(--cor-secundaria);
  padding:30px; border-radius: var(--borda-arredondada); box-shadow: var(--sombra);
  transition: all 0.3s ease;
}
.container.editing { border: 2px solid var(--cor-info); box-shadow: 0 0 15px rgba(0, 123, 255, 0.2); }

.form-section {
  margin-bottom:30px; padding:20px; border-radius:12px; background:#fff;
  border:1px solid #e0e0e0; box-shadow: var(--sombra-suave);
  transition: background 0.3s, border-color 0.3s;
}
.form-section:last-of-type { margin-bottom: 0; }
.form-section label { font-weight:600; display:block; margin-bottom:8px; color:var(--cor-primaria); transition: color 0.3s; }
.form-section input, .form-section textarea, .form-section select {
  width:100%; padding:12px;
  border-radius:8px; border:1px solid #ccc; font-size:15px;
  background:#f9f9f9; transition:border-color .3s, background 0.3s, color 0.3s; box-sizing: border-box;
}
.form-section .input-group {
    display: flex;
    gap: 20px;
    align-items: flex-start;
}
.form-section .input-group > div {
    flex: 1;
}
.form-section input, .form-section textarea { margin-bottom:12px; }
.form-section input:focus, .form-section textarea:focus, .form-section select:focus { border-color: var(--cor-sucesso); }
.form-section textarea { resize:vertical; min-height:80px; }
.date-selector-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }

.checkbox-group {
  display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px;
  max-height:300px; overflow-y:auto; padding-right:12px;
}
.checkbox-group label {
  background:#d0e4ff; padding:8px 12px; border-radius:8px; cursor:pointer;
  display:flex; align-items:center; gap:6px; white-space:nowrap; max-width:220px;
  overflow:hidden; text-overflow:ellipsis; box-shadow:0 2px 4px rgba(0,0,0,0.05);
  transition: background 0.3s, color 0.3s;
}
.checkbox-group input[type=checkbox] { margin:0; cursor:pointer; }
.checkbox-group label:hover { background:#a8cfff; }

.tooltip {
  position:absolute; background:var(--cor-primaria); color:#fff; padding:8px 12px;
  border-radius:8px; font-size:14px; z-index:100; box-shadow: var(--sombra-suave);
  opacity:0; pointer-events:none; transition:opacity .2s; max-width:280px;
  white-space:normal; text-align:center; transform:translateX(-50%);
}
.tooltip::after {
  content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%) rotate(45deg);
  width:10px; height:10px; background:var(--cor-primaria); margin-top:-5px;
}
.tooltip.below::after { top:auto; bottom:100%; margin-bottom:-5px; }

.icon-carro, .icon-moto { margin-left:5px; font-size:1em; }

.buttons { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-top:30px; }
button {
  padding:14px 28px; font-size:16px; border:none; border-radius:10px; cursor:pointer;
  transition:.3s ease-in-out; flex:1 1 180px; font-weight:600; text-transform:uppercase;
}
button:hover { opacity:.9; transform:translateY(-3px); box-shadow:0 6px 12px rgba(0,0,0,0.15); }
#addServiceBtn { background:var(--cor-sucesso); color:#fff; }
#addServiceBtn.editing { background: var(--cor-info); }
#clearListBtn { background:var(--cor-erro); color:#fff; }
#exportDropdown { position:relative; flex:1 1 180px; min-width:160px; }
#exportDropdown > button { width:100%; background:var(--cor-info); color:#fff; border:none; border-radius:10px; padding:14px 28px; }

.dropdown-content {
  display:none; position:absolute; top:100%; left:0; width:100%;
  background:#fff; border:1px solid #ddd; border-top:none;
  border-radius:0 0 10px 10px; box-shadow: var(--sombra-suave); z-index:1000;
  list-style:none; margin:0; padding:0; transition: background 0.3s, border-color 0.3s;
}
.dropdown-content li { margin:0; padding:0; }
.dropdown-content button {
  display:block; width:100%; background:transparent; color:#333; border:none;
  padding:8px 15px; text-align:left; font-size:14px; cursor:pointer;
}
.dropdown-content button:hover { background:#f0f0f0; color: var(--cor-primaria); }

.list-controls {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-top: 30px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.list-controls > div {
    flex: 1;
    min-width: 200px;
}

.info-box {
  margin-bottom: 20px; padding: 20px; border-radius: var(--borda-arredondada);
  background: #fff; border: 1px solid #e0e0e0; box-shadow: var(--sombra-suave);
  text-align: center; font-weight: 600; font-size: 1.2em;
  transition: background 0.3s, border-color 0.3s;
}

#preview {
  padding:20px; border-radius:12px; max-height:600px; overflow-y:auto;
  background:#fff; border:1px solid #ddd; box-shadow: var(--sombra-suave);
  transition: background 0.3s, border-color 0.3s;
}
#emptyMessage { text-align:center; color:#888; padding:20px; font-size:1.1em; transition: color 0.3s; }

.service-box {
  border-radius:12px; padding:15px; margin-bottom:15px;
  border-left: 8px solid var(--cor-info); 
  background: #e7f3ff;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  position:relative; 
  transition: background 0.3s, border-color 0.3s;
}

.service-box:last-of-type { margin-bottom: 0; }
.service-box h3 { margin:0 0 10px 0; font-size:20px; color:var(--cor-primaria); }
.service-box p { margin:5px 0; font-size:15px; }
.service-box strong { color: var(--cor-primaria); }
.service-box .actions { position:absolute; top:15px; right:15px; display:flex; gap:8px; }
.service-box .actions button { padding: 5px 8px; font-size: 1em; flex: 0; min-width: auto; text-transform: none;}


.toast {
  position:fixed; left:50%; transform:translateX(-50%); bottom:20px;
  padding:15px 20px; border-radius:8px; background:var(--cor-primaria);
  color:#fff; font-weight:600; display:none; z-index:1000;
}
.toast.success { background:var(--cor-sucesso); }
.toast.error { background:var(--cor-erro); }
.toast.warning { background:var(--cor-aviso); }

.footer { text-align:center; padding:20px; margin-top:auto; background:var(--cor-primaria); color:#fff; font-size:14px; transition: background 0.3s; }

@media(max-width:768px){
    .form-section .input-group {
        flex-direction: column;
        gap: 0;
    }
}
@media(max-width:520px){
  .header h2 { font-size:20px; text-align:center; }
  .checkbox-group label { max-width:100%; white-space:normal; text-overflow:initial; }
  .mode-toggle { top: 10px; right: 10px; width: 45px; height: 25px; }
  .mode-toggle .slider:before { height: 18px; width: 18px; }
  .list-controls { flex-direction: column; align-items: stretch; }
}
</style>
</head>
<body>

<div class="header">
  <img src="https://m2visual.com.br/wp-content/uploads/2024/10/e9b84a_710667977e194efba60bd01d09f82977mv2.webp" alt="M2Visual Logo">
  <h2>PCP - Escala Di√°ria</h2>
  <label class="mode-toggle">
    <input type="checkbox" id="mode-toggle-checkbox">
    <span class="slider"></span>
  </label>
</div>

<div class="container" id="mainContainer">
  <div class="form-section">
    <div class="date-selector-wrapper">
        <label for="escalaDate">Data da Escala:</label>
        <input type="date" id="escalaDate">
    </div>
    <label for="service">Cliente: *</label>
    <input type="text" id="service" placeholder="Digite o nome do cliente" required>
    
    <label for="osNumber">N√∫mero da OS: (opcional)</label>
    <input type="text" id="osNumber" placeholder="Digite o n√∫mero da OS se houver">
  </div>

  <div class="form-section">
      <div class="input-group">
        <div>
            <label for="priority">Prioridade: (opcional)</label>
            <select id="priority">
              <option value="">-- Selecione --</option>
              <option value="Alta">Alta</option>
              <option value="M√©dia">M√©dia</option>
              <option value="Baixa">Baixa</option>
            </select>
        </div>
        <div>
            <label for="etapa">Etapa do Servi√ßo: (opcional)</label>
            <select id="etapa">
              <option value="">-- Selecione uma etapa --</option>
              <option value="Instala√ß√£o Agendada">Instala√ß√£o Agendada</option>
              <option value="Pronto p/ Instala√ß√£o">Pronto p/ Instala√ß√£o</option>
              <option value="Produ√ß√£o Interna">Produ√ß√£o Interna</option>
              <option value="Aguardando Material">Aguardando Material</option>
              <option value="Confirmar medida">Confirmar medida</option>
              <option value="Outros">Outros</option>
            </select>
            <div id="outraEtapaContainer" style="display: none; margin-top: 10px;">
                <input type="text" id="outraEtapaInput" placeholder="Especifique a etapa...">
            </div>
        </div>
      </div>
  </div>

  <div class="form-section">
    <label>Carros: *</label>
    <div class="checkbox-group" id="carsList"></div>
  </div>

  <div class="form-section">
    <label>Funcion√°rios: *</label>
    <div class="checkbox-group" id="employeesList"></div>
  </div>

  <div class="form-section">
    <label for="description">Tarefa: *</label>
    <textarea id="description" placeholder="Digite a tarefa do servi√ßo" required></textarea>
  </div>

  <div class="buttons">
    <button id="addServiceBtn" type="button">Adicionar Servi√ßo</button>
    <button id="clearListBtn" type="button">Limpar Escala</button>
    <div id="exportDropdown">
      <button id="exportMainBtn" type="button">Exportar como ‚¨á</button>
      <ul class="dropdown-content" id="dropdownContent">
        <li><button id="exportTxtBtn" type="button">TXT</button></li>
        <li><button id="exportPdfBtn" type="button">PDF</button></li>
        <li><button id="copyBtn" type="button">WhatsApp</button></li>
      </ul>
    </div>
  </div>
  
  <div class="list-controls">
    <div>
        <label for="searchInput">Buscar Servi√ßo:</label>
        <input type="search" id="searchInput" placeholder="Buscar por cliente, funcion√°rio...">
    </div>
    <div>
        <label for="sortOrder">Ordenar por:</label>
        <select id="sortOrder">
          <option value="default">Padr√£o (Cria√ß√£o)</option>
          <option value="priority">Prioridade</option>
          <option value="client">Cliente (A-Z)</option>
        </select>
    </div>
  </div>

  <div class="info-box">
    <span id="serviceCount">Total de Servi√ßos: 0</span>
  </div>

  <div id="preview">
    <p id="emptyMessage">Nenhum servi√ßo adicionado ainda.</p>
  </div>
</div>

<footer class="footer">
  ¬© Sistema criado por <a href="https://www.instagram.com/senos.designer/" target="_blank">Jo√£o Victor Senos</a>
</footer>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const DEFAULT_EMPLOYEES = [
    { nome:"MINEIRO", funcao:"ADESIVADOR", habilitacao:[] }, { nome:"ALEX", funcao:"ADESIVADOR, INSTALADOR", habilitacao:[] },
    { nome:"BRENNO", funcao:"AJUDANTE", habilitacao:[] }, { nome:"GRINGO", funcao:"INSTALADOR, MONTADOR, MARCENEIRO", habilitacao:[] },
    { nome:"LIGEIRINHO", funcao:"INSTALADOR, ADESIVADOR, MONTADOR, ILUMINA√á√ÉO", habilitacao:[] }, { nome:"GLEISTON", funcao:"SERRALHEIRO, INSTALADOR", habilitacao:["CARRO"] },
    { nome:"GUIGUI", funcao:"INSTALADOR, SERRALHEIRO, ADESIVADOR, ILUMINA√á√ÉO, MONTADOR", habilitacao:["MOTO"] }, { nome:"GUILHERME", funcao:"AJUDANTE", habilitacao:[] },
    { nome:"JOAOZINHO", funcao:"AJUDANTE", habilitacao:[] }, { nome:"JONATHA", funcao:"INSTALADOR, SERRALHEIRO, MONTADOR", habilitacao:["MOTO","CARRO"] },
    { nome:"ORELHA", funcao:"MONTADOR, INSTALADOR", habilitacao:[] }, { nome:"KENNETH", funcao:"INSTALADOR, MONTADOR", habilitacao:[] },
    { nome:"LUCINHO", funcao:"MAQUIN√ÅRIO", habilitacao:["CARRO"] }, { nome:"DJ", funcao:"PINTOR, INSTALADOR", habilitacao:["MOTO","CARRO"] },
    { nome:"MARCELO", funcao:"LETRISTA, MONTADOR, ILUMINA√á√ÉO, INSTALADOR", habilitacao:["MOTO","CARRO"] }, { nome:"MATHEUS", funcao:"INSTALADOR, MONTADOR, ADESIVADOR", habilitacao:["MOTO","CARRO"] },
    { nome:"MATHEUS CEZARETE", funcao:"INSTALADOR, ADESIVADOR", habilitacao:["CARRO"] }, { nome:"MATHIAS CEZARETE", funcao:"ADESIVADOR", habilitacao:["MOTO"] },
    { nome:"VINICIUS", funcao:"MAQUIN√ÅRIO, INSTALADOR", habilitacao:["CARRO"] }, { nome:"SHOW", funcao:"MONTADOR, PINTOR, INSTALADOR", habilitacao:[] },
    { nome:"WANDERSON", funcao:"SERRALHEIRO, INSTALADOR", habilitacao:["MOTO","CARRO"] }, { nome:"WESLEY", funcao:"INSTALADOR, LETRISTA, ILUMINA√á√ÉO, MONTADOR", habilitacao:["MOTO","CARRO"] },
    { nome:"MUMUZINHO", funcao:"INSTALADOR, MONTADOR", habilitacao:[] }, { nome:"SHESLEY", funcao:"SERRALHEIRO, ADESIVADOR, PINTOR, INSTALADOR, MONTADOR", habilitacao:["MOTO","CARRO"] }
  ];

  const DEFAULT_CARS = ['UNO', 'CAMINH√ÉO BA√ö', 'CAMINH√ÉO ABERTO', 'MOTO', 'STRADA'];
  
  let listaServicos = [];
  let editIndex = -1;

  const elements = {
    serviceInput: document.getElementById('service'), osInput: document.getElementById('osNumber'),
    descriptionInput: document.getElementById('description'), priorityInput: document.getElementById('priority'),
    etapaInput: document.getElementById('etapa'), employeesList: document.getElementById('employeesList'),
    carsList: document.getElementById('carsList'), previewDiv: document.getElementById('preview'),
    serviceCountDiv: document.getElementById('serviceCount'), addServiceBtn: document.getElementById('addServiceBtn'),
    exportDropdown: document.getElementById('exportDropdown'), exportMainBtn: document.getElementById('exportMainBtn'),
    dropdownContent: document.getElementById('dropdownContent'), clearListBtn: document.getElementById('clearListBtn'),
    toast: document.getElementById('toast'), exportTxtBtn: document.getElementById('exportTxtBtn'),
    exportPdfBtn: document.getElementById('exportPdfBtn'), copyBtn: document.getElementById('copyBtn'),
    emptyMessage: document.getElementById('emptyMessage'), sortOrderSelect: document.getElementById('sortOrder'),
    mainContainer: document.getElementById('mainContainer'), modeToggleCheckbox: document.getElementById('mode-toggle-checkbox'),
    escalaDateInput: document.getElementById('escalaDate'), searchInput: document.getElementById('searchInput'),
    outraEtapaContainer: document.getElementById('outraEtapaContainer'), outraEtapaInput: document.getElementById('outraEtapaInput'),
  };

  function initializeApp() {
    // For√ßar atualiza√ß√£o sempre que carregar
    localStorage.setItem('m2visual_employees', JSON.stringify(DEFAULT_EMPLOYEES));
    if (!localStorage.getItem('m2visual_cars')) {
        localStorage.setItem('m2visual_cars', JSON.stringify(DEFAULT_CARS));
    }
    const today = new Date().toISOString().split('T')[0];
    elements.escalaDateInput.value = today;
    loadServicesForDate();
  }

  function getStorageKey() {
    const date = elements.escalaDateInput.value;
    return `escalaServicos-${date}`;
  }

  function loadServicesForDate() {
    listaServicos = JSON.parse(localStorage.getItem(getStorageKey())) || [];
    limparFormulario();
    ordenarServicos();
  }

  function saveToLocalStorage(){ localStorage.setItem(getStorageKey(), JSON.stringify(listaServicos)); }
  function showToast(msg, type = 'success', time = 2000) {
      elements.toast.textContent = msg;
      elements.toast.className = `toast ${type}`;
      elements.toast.style.display = 'block';
      setTimeout(() => { elements.toast.style.display = 'none'; }, time);
  }

  function setupTooltip(el, text){
    el.addEventListener('mouseenter', () => {
      const tip = document.createElement('div'); tip.className = 'tooltip'; tip.textContent = text;
      document.body.appendChild(tip);
      const rect = el.getBoundingClientRect();
      let top = rect.top + window.scrollY - tip.offsetHeight - 8;
      if (top < 0) { top = rect.bottom + window.scrollY + 8; tip.classList.add('below'); }
      tip.style.left = `${rect.left + rect.width / 2}px`;
      tip.style.top = `${top}px`;
      tip.style.opacity = '1'; el.currentTooltip = tip;
    });
    el.addEventListener('mouseleave', () => { if(el.currentTooltip){ el.currentTooltip.remove(); el.currentTooltip = null; } });
  }

  function renderCheckboxes(container, items, type) {
    container.innerHTML = '';
    items.forEach(item => {
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        if (type === 'employee') {
            const employee = item;
            cb.value = employee.nome;
            label.appendChild(cb);
            label.append(` ${employee.nome}`);
            if (employee.habilitacao.includes('CARRO')) {
                const car = document.createElement('span'); car.className = 'icon-carro'; car.textContent = 'üöó'; label.appendChild(car);
            }
            if (employee.habilitacao.includes('MOTO')) {
                const mot = document.createElement('span'); mot.className = 'icon-moto'; mot.textContent = 'üèçÔ∏è'; label.appendChild(mot);
            }
            setupTooltip(label, `${employee.funcao} ${employee.habilitacao.length ? '- Habilitado: ' + employee.habilitacao.join(', ') : ''}`);
        } else {
            cb.value = item;
            label.appendChild(cb);
            label.append(` ${item}`);
        }
        container.appendChild(label);
    });
  }

  function atualizarCheckboxes(excecaoFuncionarios = []) {
    const employees = JSON.parse(localStorage.getItem('m2visual_employees'));
    const cars = JSON.parse(localStorage.getItem('m2visual_cars'));
    const funcionariosUsados = listaServicos.flatMap(s => s.employees).filter(emp => !excecaoFuncionarios.includes(emp));
    const funcionariosDisponiveis = employees.filter(e => !funcionariosUsados.includes(e.nome));
    
    renderCheckboxes(elements.employeesList, funcionariosDisponiveis, 'employee');
    renderCheckboxes(elements.carsList, cars, 'car');
  }

  function atualizarPreview(filterText = '') {
    elements.previewDiv.innerHTML = '';
    
    const filteredList = listaServicos.filter(s => {
        const searchTerm = filterText.toLowerCase();
        return (
            s.service.toLowerCase().includes(searchTerm) ||
            s.osNumber.toLowerCase().includes(searchTerm) ||
            s.description.toLowerCase().includes(searchTerm) ||
            s.employees.some(e => e.toLowerCase().includes(searchTerm))
        );
    });

    if (filteredList.length === 0) {
        elements.previewDiv.appendChild(elements.emptyMessage);
    }
    
    elements.serviceCountDiv.textContent = `Total de Servi√ßos: ${filteredList.length}`;
    
    filteredList.forEach(s => {
      const index = listaServicos.indexOf(s);
      const box = document.createElement('div');
      box.className = 'service-box';
      box.innerHTML = `<h3>${s.service}${s.osNumber ? ' (OS: ' + s.osNumber + ')' : ''}</h3>
        <p><strong>Etapa:</strong> ${s.etapa || 'N√£o definida'}</p>
        <p><strong>Prioridade:</strong> ${s.priority || 'N√£o definida'}</p>
        <p><strong>Carros:</strong> ${s.cars.join(', ') || 'Nenhum'}</p>
        <p><strong>Funcion√°rios:</strong> ${s.employees.join(', ') || 'Nenhum'}</p>
        <p><strong>Tarefa:</strong> ${s.description}</p>`;
      
      const actions = document.createElement('div'); actions.className = 'actions';
      const editBtn = document.createElement('button'); editBtn.textContent = '‚úèÔ∏è';
      editBtn.onclick = () => editarServico(index);
      const delBtn = document.createElement('button'); delBtn.textContent = 'üóëÔ∏è';
      delBtn.onclick = () => { if(confirm('Tem certeza que deseja excluir este servi√ßo?')) { deletarServico(index); } };
      actions.appendChild(editBtn); actions.appendChild(delBtn); box.appendChild(actions);
      elements.previewDiv.appendChild(box);
    });
  }

  function adicionarServico(){
    const service = elements.serviceInput.value.trim();
    const os = elements.osInput.value.trim();
    const priority = elements.priorityInput.value;
    const etapaSelecionada = elements.etapaInput.value;
    let etapaFinal = etapaSelecionada;
    if (etapaSelecionada === 'Outros') {
        etapaFinal = elements.outraEtapaInput.value.trim() || 'Outros';
    }
    const description = elements.descriptionInput.value.trim();
    const employees = Array.from(document.querySelectorAll('#employeesList input:checked')).map(cb => cb.value);
    const cars = Array.from(document.querySelectorAll('#carsList input:checked')).map(cb => cb.value);
    
    if(!service || !description || employees.length === 0 || cars.length === 0){ showToast('Preencha todos os campos obrigat√≥rios!','error'); return; }

    const servico = { service, osNumber:os, priority, etapa: etapaFinal, description, employees, cars };

    if (editIndex >= 0) {
      servico.creationOrder = listaServicos[editIndex].creationOrder;
      listaServicos[editIndex] = servico;
      showToast('Servi√ßo atualizado!');
    } else {
      servico.creationOrder = Date.now();
      listaServicos.push(servico);
      showToast('Servi√ßo adicionado!');
    }
    
    saveToLocalStorage();
    limparFormulario();
    ordenarServicos();
  }

  function limparFormulario(){
    elements.serviceInput.value = ''; elements.osInput.value = '';
    elements.priorityInput.value = ''; elements.etapaInput.value = '';
    elements.descriptionInput.value = '';
    elements.outraEtapaContainer.style.display = 'none';
    elements.outraEtapaInput.value = '';
    editIndex = -1;
    elements.addServiceBtn.textContent = 'Adicionar Servi√ßo';
    elements.addServiceBtn.classList.remove('editing');
    elements.mainContainer.classList.remove('editing');
    atualizarCheckboxes();
  }

  function editarServico(idx){
    const s = listaServicos[idx];
    elements.serviceInput.value = s.service;
    elements.osInput.value = s.osNumber;
    elements.priorityInput.value = s.priority;
    elements.descriptionInput.value = s.description;
    
    const standardEtapas = Array.from(elements.etapaInput.options).map(opt => opt.value).filter(val => val);
    if (standardEtapas.includes(s.etapa)) {
        elements.etapaInput.value = s.etapa;
        elements.outraEtapaContainer.style.display = 'none';
        elements.outraEtapaInput.value = '';
    } else {
        elements.etapaInput.value = 'Outros';
        elements.outraEtapaContainer.style.display = 'block';
        elements.outraEtapaInput.value = s.etapa || '';
    }
    
    atualizarCheckboxes(s.employees);
    Array.from(document.querySelectorAll('#carsList input')).forEach(cb => cb.checked = s.cars.includes(cb.value));
    Array.from(document.querySelectorAll('#employeesList input')).forEach(cb => cb.checked = s.employees.includes(cb.value));

    editIndex = idx;
    elements.addServiceBtn.textContent = 'Salvar Altera√ß√µes';
    elements.addServiceBtn.classList.add('editing');
    elements.mainContainer.classList.add('editing');
    elements.serviceInput.focus();
    showToast('Edite o servi√ßo e clique em "Salvar Altera√ß√µes".','warning',4000);
  }

  function deletarServico(idx){ 
    listaServicos.splice(idx, 1);
    saveToLocalStorage();
    atualizarCheckboxes();
    ordenarServicos();
    showToast('Servi√ßo deletado!', 'error');
  }

  function limparEscala(){ 
    if(confirm('Tem certeza que deseja limpar toda a escala deste dia?')){ 
      listaServicos = []; 
      saveToLocalStorage(); 
      atualizarCheckboxes(); 
      atualizarPreview(); 
      showToast('Escala limpa!'); 
    }
  }

  function gerarTextoEscala(title, separator, useBold = false) {
    let txt = `${title}${separator}${separator}`;
    const b = useBold ? '*' : '';
    listaServicos.forEach((s, i) => {
        txt += `${i + 1}. ${b}Cliente:${b} ${s.service} ${s.osNumber ? '(OS: ' + s.osNumber + ')' : ''}${separator}`;
        txt += `   ${b}Etapa:${b} ${s.etapa || 'N√£o definida'}${separator}`;
        txt += `   ${b}Prioridade:${b} ${s.priority || 'N√£o definida'}${separator}`;
        txt += `   ${b}Carros:${b} ${s.cars.join(', ')}${separator}`;
        txt += `   ${b}Funcion√°rios:${b} ${s.employees.join(', ')}${separator}`;
        txt += `   ${b}Tarefa:${b} ${s.description}${separator}${separator}`;
    });
    return txt;
  }

  function exportarTxt(){
    const txt = gerarTextoEscala('ESCALA DI√ÅRIA', '\n');
    const blob = new Blob([txt],{type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `escala-${elements.escalaDateInput.value}.txt`;
    a.click();
  }
  
  function exportarPdf(){ 
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const dataFormatada = new Date(elements.escalaDateInput.value + 'T00:00:00').toLocaleDateString('pt-BR');
    doc.setFontSize(16);
    doc.text(`ESCALA DI√ÅRIA - ${dataFormatada}`, 10, 15);
    doc.setFontSize(10);
    let y = 25;
    listaServicos.forEach((s,i) => {
      if (y > 270) { doc.addPage(); y = 15; }
      const textLines = doc.splitTextToSize(
        `${i + 1}. Cliente: ${s.service} ${s.osNumber ? '(OS: ' + s.osNumber + ')' : ''}\n` +
        `Etapa: ${s.etapa || 'N√£o definida'}\n` +
        `Prioridade: ${s.priority || 'N√£o definida'}\n` +
        `Carros: ${s.cars.join(', ')}\n` +
        `Funcion√°rios: ${s.employees.join(', ')}\n` +
        `Tarefa: ${s.description}`, 180
      );
      doc.text(textLines, 10, y);
      y += (textLines.length * 5) + 10;
    });
    doc.save(`escala-${elements.escalaDateInput.value}.pdf`);
  }

  function copiarWhatsapp(){
    const txt = gerarTextoEscala('*ESCALA DI√ÅRIA*', '\n', true);
    navigator.clipboard.writeText(txt)
      .then(() => showToast('Copiado para √°rea de transfer√™ncia!', 'success'))
      .catch(() => showToast('Erro ao copiar!', 'error'));
  }

  function ordenarServicos(){
    const ordem = elements.sortOrderSelect.value;
    const priorityMap = { 'Alta': 3, 'M√©dia': 2, 'Baixa': 1 };
    if (ordem === 'priority') {
        listaServicos.sort((a,b) => (priorityMap[b.priority] || 0) - (priorityMap[a.priority] || 0));
    } else if (ordem === 'client') {
        listaServicos.sort((a,b) => a.service.localeCompare(b.service));
    } else {
        listaServicos.sort((a,b) => a.creationOrder - b.creationOrder);
    }
    atualizarPreview(elements.searchInput.value);
  }

  // Dark Mode
  function enableDarkMode() { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); elements.modeToggleCheckbox.checked = true; }
  function disableDarkMode() { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); elements.modeToggleCheckbox.checked = false; }
  function toggleMode() { document.body.classList.contains('dark-mode') ? disableDarkMode() : enableDarkMode(); }
  const savedTheme = localStorage.getItem('theme');
  const userPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  if (savedTheme === 'dark' || (savedTheme === null && userPrefersDark)) { enableDarkMode(); } else { disableDarkMode(); }

  // Event Listeners
  elements.addServiceBtn.addEventListener('click', adicionarServico);
  elements.clearListBtn.addEventListener('click', limparEscala);
  elements.exportMainBtn.addEventListener('click', () => { elements.dropdownContent.style.display = elements.dropdownContent.style.display === 'block' ? 'none' : 'block'; });
  document.addEventListener('click', e => { if (!elements.exportDropdown.contains(e.target)) { elements.dropdownContent.style.display = 'none'; } });
  elements.exportTxtBtn.addEventListener('click', exportarTxt);
  elements.exportPdfBtn.addEventListener('click', exportarPdf);
  elements.copyBtn.addEventListener('click', copiarWhatsapp);
  elements.sortOrderSelect.addEventListener('change', ordenarServicos);
  elements.modeToggleCheckbox.addEventListener('change', toggleMode);
  elements.escalaDateInput.addEventListener('change', loadServicesForDate);
  elements.searchInput.addEventListener('input', () => atualizarPreview(elements.searchInput.value));
  elements.etapaInput.addEventListener('change', () => {
    if (elements.etapaInput.value === 'Outros') {
        elements.outraEtapaContainer.style.display = 'block';
        elements.outraEtapaInput.focus();
    } else {
        elements.outraEtapaContainer.style.display = 'none';
    }
  });


  initializeApp();
});
</script>
</body>
</html>
